<!DOCTYPE html>
<html lang="en">
    <head>
        <script>
            !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId setPersonProperties".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_vYRCWO99s1v9OuU1y6xF23wjQxnFT9wJ4paSJ9mGQf2',{api_host:'https://us.i.posthog.com', person_profiles: 'identified_only' // or 'always' to create profiles for anonymous users as well
                })
        </script>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Punchpredictor Chat" />
        <meta name="author" content="Bob" />
        <title>PUNCHPREDICTOR CHAT</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/boxing_gloves-removebg-preview.png" />

        <!-- Google Analytics Tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4F873DFQPQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4F873DFQPQ');
</script>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="styles.css" rel="stylesheet" />
        <!--GOOGLE SEARCH VERIFICATION-->
        <meta name="google-site-verification" content="kGhZUcmdYMqwcuJCFVWz7yGrAx_cN5hWqydgcTeqz0M" />

        <style>
            .highlight {
                background-color: #d4edda; /* Light green background */
            }
        </style>
    </head>

		<body>
			<!-- Navigation-->
			<nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
				<div class="container">
					<a class="navbar-brand text-bigger-specifically" href="#page-top">PUNCHPREDICTOR CHAT</a>
					<button class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
						Menu
						                    <!-- Bars Icon Embed with .bars class -->
<div class="bars">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
        <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/>
    </svg>
</div>
					</button>
					<div class="collapse navbar-collapse" id="navbarResponsive">
						<ul class="navbar-nav ms-auto">

                        <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" href="http://punchpredictor.com/upcomingEvents">Upcoming Events</a></li>
							<li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" id="navRegister" href="http://punchpredictor.com/register.html">Register</a></li>
							<li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" href="http://punchpredictor.com/leaderBoard.html">LeaderBoard</a></li>
							<li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" id="navSignIn" href="http://punchpredictor.com/login.html">Sign in</a></li>
                            <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" id="navSignIn" href="http://punchpredictor.com/">Website Info</a></li>
                            <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" id="navSignIn" href="http://punchpredictor.com/previousEvents.html">Previous Events</a></li>
                            <li class="nav-item mx-0 mx-lg-1">
                                <a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" id="navSignOut" href="javascript:void(0);">Sign Out</a>
                            </li>
							<!-- <li class="nav-item mx-0 mx-lg-1"><a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" href="#resume">Experience</a></li> -->
						</ul>
					</div>
				</div>
			</nav>


			<div class="container mt-5 w-100">
								<!-- Collapsible bar for selecting names -->
								<div class="row" style='margin-top: 200px;'>
									<div class="">
										<button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#nameList" aria-expanded="false" aria-controls="nameList">
											Select a Chat
										</button>
										<div class="collapse" id="nameList">
											<div class="card card-body">
												<ul class="list-group">
													<li class="list-group-item">
														<button class="btn btn-link chat-user-btn" data-username="flakko">flakko</button>
													</li>
													<li class="list-group-item">
														<button class="btn btn-link chat-user-btn" data-username="thatkid435">thatkid435</button>
													</li>
													<li class="list-group-item">
														<button class="btn btn-link chat-user-btn" data-username="susMcgee">susMcgee</button>
													</li>
													<!-- Add more users as needed -->
												</ul>
											</div>
										</div>
									</div>
								</div>


					<div class="col-md-8">
                            <!-- Section for displaying recent chats -->
    <div class="card mb-3">
        <div class="card-header">
            <h5>Recent Chats</h5>
        </div>
        <div class="card-body">
            <ul class="list-group" id="recentChatsList">
                <!-- Fake data for demonstration -->
                <li class="list-group-item">
                    <button class="btn btn-link chat-user-btn" data-username="user1"></button>
                    <span class="badge bg-success"></span>
                </li>
                <li class="list-group-item">
                    <button class="btn btn-link chat-user-btn" data-username="user2"></button>
                    <span class="badge bg-warning"></span>
                </li>
                <li class="list-group-item">
                    <button class="btn btn-link chat-user-btn" data-username="user3"></button>
                    <span class="badge bg-success"></span>
                </li>
                <!-- Add more recent chats as needed -->
            </ul>
        </div>
    </div>
						<div class="card">
							<div class="card-header">
								<h5 id="chatWith">Select a user to chat with by clicking the "Select a Chat" button</h5>
							</div>
							<div class="card-body chat-window" id="chatWindow">
								<!-- Messages will be displayed here -->
							</div>
							<div class="card-footer">
								<div class="input-group">
									<input type="text" id="messageInput" class="form-control" placeholder="Type a message" />
									<button class="btn btn-primary" id="sendMessageButton">Send</button>
								</div>
							</div>
						</div>
					</div>
				</div>

    <script type="module">


let username; // Declare a global variable
document.addEventListener('DOMContentLoaded', function() {
    const registerKey = localStorage.getItem('registerKey');
    if (registerKey) {
        fetch(`https://g8mjh5drkf.execute-api.us-east-1.amazonaws.com/dev?page=verify&result=${registerKey}`)
            .then(response => response.json())
            .then(data => {
                const responseBody = JSON.parse(data.body);
                if (data.statusCode === 200) {
                    username = responseBody.username; // Assign value to the local variable

                    // Proceed with the remaining DOM manipulations
                    updateNavbar(username);
                    setupSignOutButton();
					fetchAndDisplayMessages();
                    populateRecentChats();
                    populateChatUserButtons();
                } else {
                    console.error('Failed to verify register key:', responseBody.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else {
        console.error('No registerKey found in localStorage');
        setupSignOutButton();
    }


    // Function to fetch and display messages
    function fetchAndDisplayMessages() {
    const chatUser = localStorage.getItem('chatUser');
    const chatWindow = document.getElementById('chatWindow');
    const apiUrl = `https://g8mjh5drkf.execute-api.us-east-1.amazonaws.com/dev?page=chat&username=${username}`;

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.statusCode === 200) {
                const messages = JSON.parse(data.body);

                // Clear the chat window
                chatWindow.innerHTML = '';

                // Construct the key for the specific branch
                const key = `${username}_${chatUser}`;

                // Check if messages exist under the specific branch
                if (messages[key]) {
                    const conversation = messages[key];

                    // Get the message keys and sort them by the numeric part
                    const sortedMessageKeys = Object.keys(conversation).sort((a, b) => {
                        const numA = parseInt(a.replace('message', ''), 10);
                        const numB = parseInt(b.replace('message', ''), 10);
                        return numA - numB;
                    });

                    // Loop through each sorted message key
                    sortedMessageKeys.forEach(messageId => {
                        const message = conversation[messageId];

                        // Display each message
                        displayMessage(message);
                    });
                } else {
                    console.log('No messages found for this specific branch.');
                }
            } else {
                console.error('Error fetching messages:', data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}




    // Function to get the current timestamp in the format YYYY-MM-DDTHH:MM:SSZ
    function getCurrentTimestamp() {
        const now = new Date();
        return now.toISOString();
    }

    // Function to send a message
    function sendMessage() {
		const sendMessageButton = document.getElementById('sendMessageButton');
    	const messageInput = document.getElementById('messageInput');
    	const result = localStorage.getItem('chatUser');  // The recipient's username
        const messageText = messageInput.value.trim();
        const timestamp = getCurrentTimestamp();

        if (messageText === '') {
            alert('Please enter a message before sending.');
            return;
        }

        // Construct the API URL with dynamic parameters
        const apiUrl = `https://g8mjh5drkf.execute-api.us-east-1.amazonaws.com/dev?page=sendMessage&username=${encodeURIComponent(username)}&result=${encodeURIComponent(result)}&emailCheck=${encodeURIComponent(messageText)}&usernameCheck=${encodeURIComponent(timestamp)}`;

        // Make the API request
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.statusCode === 200) {
                    console.log('Message sent successfully:', data);
                    // Optionally, clear the input field
                    messageInput.value = '';
                    // Optionally, add the message to the chat window
                    displayMessage({ sender: username, text: messageText, timestamp: timestamp });
                    populateRecentChats();
                } else {
                    console.error('Failed to send message:', data);
                    alert('Failed to send message. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending the message.');
            });
    }

    function populateChatUserButtons() {
    const apiUrl = 'https://g8mjh5drkf.execute-api.us-east-1.amazonaws.com/dev?page=leaderboard';
    const nameListElement = document.getElementById('nameList').querySelector('.list-group');

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.statusCode === 200) {
                const users = JSON.parse(data.body);

                // Clear the existing list
                nameListElement.innerHTML = '';

                // Loop through each user in the response
                users.forEach(user => {
                    const username1 = user.username1;

                    // Create a new list item with a button for each user
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';

                    const button = document.createElement('button');
                    button.className = 'btn btn-link chat-user-btn';
                    button.setAttribute('data-username', username1);
                    button.textContent = username1;

                    // Append the button to the list item and the list item to the list
                    listItem.appendChild(button);
                    nameListElement.appendChild(listItem);
                });

                // Initialize event listeners after buttons are created
                initializeChatUserSelection();
            } else {
                console.error('Error fetching users:', data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

    // Function to display a message in the chat window
    function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message ' + (message.sender === username ? 'sent' : 'received');
        const messageText = document.createElement('div');
        messageText.className = 'text';

        // Prepend the sender's identity
        if (message.sender === username) {
            messageText.textContent = `Me: ${message.text}`;
        } else {
            messageText.textContent = `${message.sender}: ${message.text}`;
        }

        messageElement.appendChild(messageText);
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
    }

        // Function to initialize chat user selection
        function initializeChatUserSelection() {
        // Get all buttons with the class 'chat-user-btn'
        const userButtons = document.querySelectorAll('.chat-user-btn');

        // Add event listeners to each button
        userButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Get the username from the data-username attribute
                const theusername = this.getAttribute('data-username');
                
                // Set the username in localStorage
                localStorage.setItem('chatUser', theusername);

                // Optionally, update the chat header or do other actions
                document.getElementById('chatWith').textContent = `Chat with ${theusername}`;
                fetchAndDisplayMessages();
            });
        });
    }

function initializeChatUser(){
            const theusername = localStorage.getItem('chatUser')
            if (theusername){
                document.getElementById('chatWith').textContent = `Chat with ${theusername}`;
            }
            else{
                document.getElementById('chatWith').textContent = `Select a user to chat with by clicking the "Select a Chat" button`;
            }

}

async function populateRecentChats() {
    const apiUrl = `https://g8mjh5drkf.execute-api.us-east-1.amazonaws.com/dev?page=chat&username=${username}`;
    const recentChatsList = document.getElementById('recentChatsList');

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.statusCode === 200) {
            const conversations = JSON.parse(data.body);
            const recentChats = [];

            // Loop through each conversation branch
            for (const branch in conversations) {
                const messages = conversations[branch];
                const messageKeys = Object.keys(messages);
                
                // Find the message key with the highest number
                const highestMessageKey = messageKeys.reduce((max, key) => {
                    const num = parseInt(key.replace('message', ''), 10);
                    return num > parseInt(max.replace('message', ''), 10) ? key : max;
                }, messageKeys[0]);

                const lastMessage = messages[highestMessageKey];

                // Extract the second username from the branch name
                const [user1, user2] = branch.split('_');
                const chatPartner = user1 === username ? user2 : user1;

                recentChats.push({
                    chatPartner: chatPartner,
                    lastMessageText: lastMessage.text,
                    lastMessageSender: lastMessage.sender,
                    lastMessageTimestamp: new Date(lastMessage.timestamp),
                    lastMessageFormatted: lastMessage.sender === username ? `Me: ${lastMessage.text}` : `${lastMessage.sender}: ${lastMessage.text}`
                });
            }

            // Sort by most recent timestamp
            recentChats.sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);

            // Get the top 3 most recent chats
            const topRecentChats = recentChats.slice(0, 3);

            // Clear the existing recent chats list
            recentChatsList.innerHTML = '';

            // Populate the recent chats section
            topRecentChats.forEach(chat => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';

                const button = document.createElement('button');
                button.className = 'btn btn-link chat-user-btn';
                button.setAttribute('data-username', chat.chatPartner);
                button.textContent = chat.chatPartner;

                const badge = document.createElement('span');
                badge.className = 'badge bg-success';
                badge.textContent = chat.lastMessageFormatted;

                listItem.appendChild(button);
                listItem.appendChild(badge);
                recentChatsList.appendChild(listItem);
            });

            // Reinitialize chat user selection for these buttons
            initializeChatUserSelection();

        } else {
            console.error('Error fetching recent chats:', data);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

    
	sendMessageButton.addEventListener('click', sendMessage);
    initializeChatUser();

});


function updateNavbar(username) {
    if (username) {
        console.log('Username:', username);
        // Hide the REGISTER and SIGN IN navigation items
        document.getElementById('navRegister').style.display = 'none';
        document.getElementById('navSignIn').style.display = 'none';

        // Create a new nav item for the user, using the username as the link text
        var navItem = document.createElement('li');
        navItem.className = 'nav-item mx-0 mx-lg-1';
        navItem.innerHTML = `<a class="nav-link py-3 px-0 px-lg-3 rounded text-bigger-specifically2" href="http://punchpredictor.com/user.html">${username}</a>`;
        document.querySelector('#navbarResponsive .navbar-nav').appendChild(navItem);
    }
}

function setupSignOutButton() {
    var signOutButton = document.getElementById('navSignOut');

    // Check if username exists in localStorage
    if (username) {
        // Show sign out button if username exists
        signOutButton.style.display = 'block';
    } else {
        // Hide sign out button if no username exists
        signOutButton.style.display = 'none';
    }

    // Add event listener for sign out action
    signOutButton.addEventListener('click', function() {
        localStorage.removeItem('registerKey'); // This will delete the username from localStorage

        // Optional: Provide feedback or redirect the user
        alert('You have been signed out.');
        window.location.href = 'http://punchpredictor.com/login.html'; // Redirects to the login page
    });
}


    </script>

 <!-- Bootstrap JS Bundle with Popper (Bootstrap 5) -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>


 
